# 매핑 수정 및 사방넷 등록 양식 다운로드 검증 보고서

## 1. 매핑 수정 (상품 검색하여 업데이트) 플로우 검증

### 1.1 SavedDataTable - 매핑코드 셀 클릭

**플로우:**

1. `TableMappingCodeCell` 클릭 → `handleEditClick(row.id, row)` 호출
2. `setEditingRow({ id, rowData: row })` → `CodeEditWindow` 모달 오픈
3. `CodeEditWindow`에 `currentRowData` 전달 (productId 포함: `editingRow.rowData.productId`)
4. 사용자가 상품 선택 → `handleCodeSelect(codeItem)` → `/api/upload/update-code` PUT 요청
5. 요청 본문: `{ rowId, codeData: { code, productId, type, postType, ... } }`
6. API 성공 시 `onCodeUpdate(rowId, code)` → `setEditingRow(null)`, `onDataUpdate()` (= `fetchSavedData()`)
7. `fetchSavedData()` → `/api/upload/list` 재조회 → 테이블 갱신

**검증 결과: ✅ 정상**

- `update-code` API: `row_data`에 `productId`, `매핑코드`, `내외주`, `택배사` 등 저장
- `upload_rows.row_data`가 JSONB로 저장되므로 `productId` 포함
- `/api/upload/list`는 `row_data`를 그대로 반환
- `useUploadData`의 `tableRows`는 `...(row.row_data || {})`로 펼치므로 `productId` 포함

### 1.2 주문 수정 페이지 (order/edit) - 매핑 수정 버튼

**플로우:**

1. "매핑 수정" 버튼 클릭 → `handleMappingEdit()`
2. 선택된 행이 있으면: 첫 번째 선택 행으로 `CodeEditWindow` 오픈
3. 선택된 행이 없으면: 필터 조건으로 `/api/upload/list` 조회 후 첫 번째 행으로 오픈
4. `CodeEditWindow`에서 상품 선택 → `handleCodeUpdate(rowId, code, codeItem)` 호출
5. `/api/upload/batch-update-code` PUT 요청 (선택된 모든 `rowIds` 일괄 업데이트)
6. `codeData.productId` 포함하여 각 행 업데이트
7. 성공 시 `fetchSavedData()` 호출하여 테이블 갱신

**검증 결과: ✅ 정상**

- `batch-update-code` API: 각 `rowId`에 대해 `codeData.productId`를 `row_data`에 저장
- `productId`가 없으면 `codeData.productId`를 저장하지 않음 (기존 로직 유지)

### 1.3 upload/view 페이지 - 매핑코드 클릭

**플로우:**

- `handleMappingCodeClick` → 상품 검색 모달/창 (별도 로직)
- 확인 필요: upload/view에서도 CodeEditWindow 사용 시 동일 플로우

---

## 2. 사방넷 등록 양식 다운로드 - sale_price → 판매가 헤더 검증

### 2.1 데이터 흐름

1. **데이터 조회**: `rowIds` 또는 `filters`로 `upload_rows`에서 `row_data` 조회
2. **productId 수집**: `dataRows.map(row => row.productId).filter(Boolean)`
3. **상품 조회**: `products` 테이블에서 `id = ANY(productIds)` 로 `sale_price` 조회
4. **맵 구성**: `productSalePriceMap[productIdKey] = p.sale_price`
5. **행별 주입**:
   - `row.productId`가 있으면 → `productSalePriceMap[productIdKey]`에서 `salePrice` 조회
   - 행사가/할인율 적용 후 `calculatedPrice` 계산
   - `row["판매가"] = calculatedPrice`, `row["sale_price"] = calculatedPrice`
6. **엑셀 생성**: `mapDataToTemplate(row, headerStr)` 호출
   - 템플릿 헤더가 "판매가"일 때: `row["판매가"]` 또는 `row["sale_price"]` 사용

### 2.2 mapDataToTemplate 검증

`utils/excelDataMapping.ts`의 `mapDataToTemplate`:

- "판매가" 헤더에 대한 별도 처리 없음 → 일반 매핑 사용
- 일반 매핑: `value = row[mappedHeader] || row[header] || ...`
- `row["판매가"]`가 `download-sabangnet`에서 설정되었으므로 값 정상 반환

**검증 결과: ✅ 정상**

- `productId` → `products.sale_price` 조회 → `row["판매가"]` 설정 → 템플릿 "판매가" 컬럼에 반영

### 2.3 잠재적 이슈

1. **productId가 없는 경우**: `row.매핑코드`로 `productSalePriceMapByCode`에서 조회 (fallback)
2. **타입 일관성**: `productIdKey = String(row.productId)`로 문자열 키 사용하여 타입 불일치 방지
3. **판매가 계산**: 수량, 행사가, 할인율, 건당 배송비 옵션 반영

---

## 3. 결론

| 항목                                                | 상태    | 비고                                        |
| --------------------------------------------------- | ------- | ------------------------------------------- |
| SavedDataTable 매핑코드 셀 클릭 → update-code       | ✅ 정상 | productId 저장 및 갱신 확인                 |
| 주문 수정 페이지 매핑 수정 버튼 → batch-update-code | ✅ 정상 | 일괄 productId 업데이트                     |
| 사방넷 등록 양식 다운로드 → sale_price → 판매가     | ✅ 정상 | productId 기반 sale_price 조회 및 엑셀 반영 |

**추가 권장사항:**

- `mapDataToTemplate`에 "판매가" 헤더용 명시적 처리 추가 시, 숫자 포맷 및 fallback 로직을 더 명확히 할 수 있음
